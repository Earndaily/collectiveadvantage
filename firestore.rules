rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // 1. Rules for the "users" collection
    match /users/{userId} {
      // Allow a user to create their initial profile only if they use their own Auth UID
      // and ensure they don't try to set their own balance to a high number
      allow create: if request.auth != null && request.auth.uid == userId;
      
      // Allow users to read their own data (to see their balance/status)
      allow read: if request.auth != null && request.auth.uid == userId;
      
      // IMPORTANT: Only allow balance/status updates via your backend/Admin 
      // or very specific logic. For now, allow specific updates for the MVP:
      allow update: if request.auth != null && request.auth.uid == userId 
                    && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['wallet_balance', 'is_active']);
    }

    // 2. Rules for "projects"
    match /projects/{projectId} {
      allow read: if true; // Everyone can see what projects are available
      allow write: if false; // Only Admin (Firebase Console) can create/edit projects
    }

    // 3. Rules for "transactions"
    match /transactions/{txId} {
      // Users can create a transaction record when they try to pay the 20k
      allow create: if request.auth != null && request.resource.data.user_uid == request.auth.uid;
      allow read: if request.auth != null && resource.data.user_uid == request.auth.uid;
    }
  }
}